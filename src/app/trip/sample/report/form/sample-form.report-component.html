@if (loaded) {
  <app-reveal #reveal [options]="revealOptions">
    @for (operation of data; track operation.id) {
      @if (operation.samples | isNotEmptyArray) {
        <section *sectionDef [style.--page-horizontal-margin]="this.parentPageDimension.pageHorizontalMargin + 'px'">
          <ng-content
            *ngTemplateOutlet="
              table;
              context: {
                operation: operation,
                samples: stats.individualSample,
                chunkSize: samplesByPage,
                tableParts: stats.sampleTableParts,
                tableTitle: 'TRIP.SAMPLE.TABLE.TITLE',
                options: stats.options,
                pmfms: stats.samplePmfm,
                pmfmsByIds: stats.samplePmfmById,
              }
            "
          ></ng-content>
        </section>
        <section *sectionDef [style.--page-horizontal-margin]="this.parentPageDimension.pageHorizontalMargin + 'px'">
          <ng-content
            *ngTemplateOutlet="
              table;
              context: {
                operation: operation,
                samples: stats.releasedSample,
                chunkSize: samplesByPage,
                tableParts: stats.releasedTableParts,
                tableTitle: 'TRIP.SAMPLE.TABLE.TAB_INDIVIDUAL_RELEASES',
                options: releasedTableOptions,
                pmfms: stats.releasedPmfm,
                pmfmsByIds: stats.releasedPmfmById,
              }
            "
          ></ng-content>
        </section>
      }
    }
  </app-reveal>
}

<ng-template
  #table
  let-operation="operation"
  let-samples="samples"
  let-chunkSize="chunkSize"
  let-tableParts="tableParts"
  let-tableTitle="tableTitle"
  let-options="options"
  let-pmfms="pmfms"
  let-pmfmsByIds="pmfmsByIds"
>
  @for (
    samplesChunk of samples | splitArrayInChunks: chunkSize;
    track samplesChunkIndex;
    let samplesChunkIndex = $index;
    let firstSampleChunk = $first;
    let lastSampleChunk = $last
  ) {
    @for (tablePart of tableParts; track partIndex; let partIndex = $index; let firstPart = $first; let lastPart = $last) {
      <section class="landscape">
        <page-header-from-report-chunk
          [i18nContext]="i18nContext"
          [title]="tableTitle"
          [pageNumber]="samplesChunkIndex + 1"
          [departureDateTime]="departureDateTime"
          [vesselName]="vesselName"
          [logoRightUrl]="logoHeadRightUrl"
          [logoLeftUrl]="logoHeadLeftUrl"
        ></page-header-from-report-chunk>
        <ion-grid class="report-section ion-no-padding">
          <ion-row class="section-title ion-margin-bottom">
            <ion-col size="auto">
              <h3>{{ 'TRIP.REPORT.FORM.NUM_OP' | translate }}</h3>
            </ion-col>
            <ion-col class="title-value ion-text-center font-large" size="auto">
              {{ operation.rankOrder }}
            </ion-col>
          </ion-row>
        </ion-grid>
        <table class="table-full-width" [style.--row-height]="'30px'">
          <thead>
            <tr>
              @if (options.labelEnabled) {
                <th class="font-medium ion-text-center" [style.--col-width]="pageDimensions.labelColumnWidth + 'px'">
                  <div>{{ 'TRIP.SAMPLE.TABLE.LABEL' | translateContext: i18nContext.suffix }}</div>
                </th>
              } @else {
                <th class="font-medium ion-text-center" [style.--col-width]="pageDimensions.rankOrderColumnWidth + 'px'">
                  <div>{{ 'TRIP.SAMPLE.TABLE.RANK_ORDER' | translateContext: i18nContext.suffix }}</div>
                </th>
              }
              @if (firstPart) {
                @if (options.taxonNameEnabled) {
                  <th class="font-medium ion-text-center" [style.--col-width]="pageDimensions.taxonNameColumnWidth + 'px'">
                    <div>{{ 'TRIP.SAMPLE.TABLE.TAXON_NAME' | translateContext: i18nContext.suffix }}</div>
                  </th>
                }
                @if (options.taxonGroupEnabled) {
                  <th class="font-medium ion-text-center" [style.--col-width]="pageDimensions.taxonGroupColumnWidth + 'px'">
                    <div>{{ 'TRIP.SAMPLE.TABLE.TAXON_GROUP' | translateContext: i18nContext.suffix }}</div>
                  </th>
                }
              }
              @for (pmfm of pmfms.slice(tablePart[0], tablePart[1]); track pmfm.id) {
                <th class="ion-text-center font-medium column-{{ pmfm.label }}" [style.--col-width]="pageDimensions.pmfmColumnWidth + 'px'">
                  <div [innerHTML]="pmfm | pmfmName: { i18nPrefix: 'TRIP.SAMPLE.PMFM.', i18nSuffix: i18nContext.suffix }"></div>
                </th>
              }
              @if (lastPart) {
                <th class="font-medium" [style.--col-width]="pageDimensions.commentColumnWidth + 'px'">
                  <div class="ion-text-center">
                    {{ 'TRIP.REPORT.FORM.COMMENTS' | translate }}
                  </div>
                </th>
              }
            </tr>
          </thead>
          <tbody>
            @for (sample of samplesChunk; track sample.id) {
              <tr>
                @if (options.labelEnabled) {
                  <td class="font-medium" [style.--col-width]="pageDimensions.labelColumnWidth + 'px'">
                    <div>
                      <b>{{ sample.label }}</b>
                    </div>
                  </td>
                } @else {
                  <td
                    class="col-tiny ion-text-center font-medium"
                    [style.padding]="0"
                    [style.--col-width]="pageDimensions.rankOrderColumnWidth + 'px'"
                  >
                    <div>
                      <b>{{ sample.rankOrder }}</b>
                    </div>
                  </td>
                }
                @if (firstPart) {
                  @if (options.taxonNameEnabled) {
                    <td [style.--col-width]="pageDimensions.taxonNameColumnWidth + 'px'">
                      {{ sample.taxonName | referentialToString }}
                    </td>
                  }
                  @if (options.taxonGroupEnabled) {
                    <td [style.--col-width]="pageDimensions.taxonGroupColumnWidth + 'px'">
                      {{ sample.taxonGroup | referentialToString }}
                    </td>
                  }
                }
                @for (pmfm of pmfms.slice(tablePart[0], tablePart[1]); track pmfm.id) {
                  <td
                    class="ion-text-center column-{{ pmfm.label }} "
                    [style.--col-width]="pageDimensions.pmfmColumnWidth + 'px'"
                    [innerHtml]="
                      sample.measurementValues
                        | mapGet: pmfm.id
                        | pmfmValue
                          : {
                              pmfm: pmfmsByIds | mapGet: pmfm.id,
                              propertyNames: ['label', 'name'],
                              showYesOrNo: true,
                            }
                    "
                  ></td>
                }
                @if (lastPart) {
                  <td [style.--col-width]="pageDimensions.commentColumnWidth + 'px'">
                    {{ sample.comments }}
                  </td>
                }
              </tr>
            }
          </tbody>
        </table>
        <page-footer-from-report-chunk [footerText]="footerText" [help]="footerHelp"></page-footer-from-report-chunk>
      </section>
    }
  }
  <!-- @for ( -->
  <!--   imagesChunk of stats.imagesByOperationId | mapGet: operation.id | splitArrayInChunks: 6; -->
  <!--   track imagesChunkIndex; -->
  <!--   let imagesChunkIndex = $index -->
  <!-- ) { -->
  <!--   <section class="landscape"> -->
  <!--     <page-header-from-report-chunk -->
  <!--       [i18nContext]="i18nContext" -->
  <!--       [title]="'TRIP.SAMPLE.TABLE.TITLE'" -->
  <!--       [pageNumber]="imagesChunkIndex + 1" -->
  <!--       [departureDateTime]="departureDateTime" -->
  <!--       [vesselName]="vesselName" -->
  <!--       [logoRightUrl]="logoHeadRightUrl" -->
  <!--       [logoLeftUrl]="logoHeadLeftUrl" -->
  <!--     ></page-header-from-report-chunk> -->
  <!--     <ion-grid class="report-section ion-no-padding"> -->
  <!--       <ion-row class="section-title ion-margin-bottom"> -->
  <!--         <ion-col size="auto"> -->
  <!--           <h3>{{ 'TRIP.REPORT.FORM.NUM_OP' | translate }}</h3> -->
  <!--         </ion-col> -->
  <!--         <ion-col class="title-value ion-text-center font-large" size="auto"> -->
  <!--           {{ operation.rankOrder }} -->
  <!--         </ion-col> -->
  <!--       </ion-row> -->
  <!--       <ion-row class="gallery"> -->
  <!--         @for (image of imagesChunk; track $index) { -->
  <!--           <ion-col size="auto"> -->
  <!--             <figure> -->
  <!--               <img [src]="image.url || image.dataUrl" [alt]="image.title" /> -->
  <!--               <figcaption>{{ image.title }}</figcaption> -->
  <!--             </figure> -->
  <!--           </ion-col> -->
  <!--         } -->
  <!--       </ion-row> -->
  <!--     </ion-grid> -->
  <!--     <page-footer-from-report-chunk [footerText]="footerText" [help]="footerHelp"></page-footer-from-report-chunk> -->
  <!--   </section> -->
  <!-- } -->
</ng-template>

<ng-template #latudePlaceHolder>
  <span class="font-large place-holder">
    <span [style.letter-spacing]="'3px'">__°__.___</span>
    N
  </span>
</ng-template>

<ng-template #longitudePlaceHolder>
  <span class="font-large place-holder">
    <span [style.letter-spacing]="'3px'">__°__.___</span>
    E ou W
  </span>
</ng-template>
