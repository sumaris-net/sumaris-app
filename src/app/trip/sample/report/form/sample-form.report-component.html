@if (loaded) {
  <app-reveal #reveal [options]="revealOptions">
    @for (operation of data; track operation.id) {
      @if (stats.individualSamplePeerOpId[operation.id] | isNotEmptyArray) {
        <section *sectionDef [style.--page-horizontal-margin]="this.parentPageDimension.pageHorizontalMargin + 'px'">
          <ng-content
            *ngTemplateOutlet="
              table;
              context: {
                operation: operation,
                samples: stats.individualSamplePeerOpId[operation.id],
                chunkSize: samplesByPage,
                tableParts: stats.sampleTableParts,
                tableTitle: 'TRIP.SAMPLE.TABLE.TITLE',
                options: stats.options,
                pmfms: stats.samplePmfms,
                pmfmsByIds: stats.samplePmfmsById,
                pmfmsTips: stats.samplePmfmsTips,
                compactPmfmsColumn: !isBlankForm,
              }
            "
          ></ng-content>
        </section>
      }
      @if (stats.releasedSamplePeerOpId[operation.id] | isNotEmptyArray) {
        <section *sectionDef [style.--page-horizontal-margin]="this.parentPageDimension.pageHorizontalMargin + 'px'">
          <ng-content
            *ngTemplateOutlet="
              table;
              context: {
                operation: operation,
                samples: stats.releasedSamplePeerOpId[operation.id],
                chunkSize: samplesByPage,
                tableParts: stats.releasedTableParts,
                tableTitle: 'TRIP.SAMPLE.TABLE.TAB_INDIVIDUAL_RELEASES',
                options: releasedTableOptions,
                pmfms: stats.releasedPmfms,
                pmfmsByIds: stats.releasedPmfmsById,
                pmfmsTips: stats.releasedPmfmsTips,
                compactPmfmsColumn: false,
              }
            "
          ></ng-content>
        </section>
      }
    }
  </app-reveal>
}

<ng-template
  #table
  let-operation="operation"
  let-samples="samples"
  let-chunkSize="chunkSize"
  let-tableParts="tableParts"
  let-tableTitle="tableTitle"
  let-options="options"
  let-pmfms="pmfms"
  let-pmfmsByIds="pmfmsByIds"
  let-pmfmsTips="pmfmsTips"
  let-compactPmfmsColumn="compactPmfmsColumn"
>
  @for (
    samplesChunk of samples | splitArrayInChunks: chunkSize;
    track samplesChunkIndex;
    let samplesChunkIndex = $index;
    let firstSampleChunk = $first;
    let lastSampleChunk = $last
  ) {
    @for (tablePart of tableParts; track partIndex; let partIndex = $index; let firstPart = $first; let lastPart = $last) {
      <section class="landscape">
        <page-header-from-report-chunk
          [i18nContext]="i18nContext"
          [title]="tableTitle"
          [pageNumber]="samplesChunkIndex + 1"
          [departureDateTime]="departureDateTime"
          [vesselName]="vesselName"
          [logoRightUrl]="logoHeadRightUrl"
          [logoLeftUrl]="logoHeadLeftUrl"
        ></page-header-from-report-chunk>
        <ion-grid class="report-section ion-no-padding">
          <ion-row class="section-title ion-margin-bottom">
            <ion-col size="auto">
              <h3>{{ 'TRIP.REPORT.FORM.NUM_OP' | translate }}</h3>
            </ion-col>
            <ion-col class="title-value ion-text-center font-large" size="auto">
              {{ operation.rankOrder }}
            </ion-col>
          </ion-row>
        </ion-grid>
        <table class="table-full-width" [style.--row-height]="'30px'">
          <thead>
            <tr>
              @if (options.labelEnabled) {
                <th class="font-medium ion-text-center" [style.--col-width]="pageDimensions.columnLabelWidth + 'px'">
                  <div>{{ 'TRIP.SAMPLE.TABLE.LABEL' | translateContext: i18nContext.suffix }}</div>
                </th>
              } @else {
                <th class="font-medium ion-text-center" [style.--col-width]="pageDimensions.columnRankOrderWidth + 'px'">
                  <div>{{ 'TRIP.SAMPLE.TABLE.RANK_ORDER' | translateContext: i18nContext.suffix }}</div>
                </th>
              }
              @if (firstPart) {
                @if (options.taxonNameEnabled) {
                  <th class="font-medium ion-text-center" [style.--col-width]="pageDimensions.columnTaxonNameWidth + 'px'">
                    <div>{{ 'TRIP.SAMPLE.TABLE.TAXON_NAME' | translateContext: i18nContext.suffix }}</div>
                  </th>
                }
                @if (options.taxonGroupEnabled) {
                  <th class="font-medium ion-text-center" [style.--col-width]="pageDimensions.columnTaxonGroupWidth + 'px'">
                    <div>{{ 'TRIP.SAMPLE.TABLE.TAXON_GROUP' | translateContext: i18nContext.suffix }}</div>
                  </th>
                }
              }
              @for (pmfm of pmfms.slice(tablePart[0], tablePart[1]); track pmfm.id) {
                @if (compactPmfmsColumn) {
                  <th class="col-tiny font-small column-{{ pmfm.label }} no-padding">
                    <table-head-pmfm-name-report-chunk
                      [pmfm]="pmfm"
                      [i18nContext]="i18nContext"
                      [pmfmTipsByPmfmIds]="pmfmsTips[partIndex]"
                    ></table-head-pmfm-name-report-chunk>
                  </th>
                } @else {
                  <th class="ion-text-center font-medium column-{{ pmfm.label }}" [style.--col-width]="pageDimensions.columnPmfmWidth + 'px'">
                    <div [innerHTML]="pmfm | pmfmName: { i18nPrefix: i18nContext.prefix, i18nSuffix: i18nContext.suffix }"></div>
                  </th>
                }
              }
              @if (lastPart) {
                <th class="font-medium col-maximum">
                  <div class="ion-text-center">
                    {{ 'TRIP.REPORT.FORM.COMMENTS' | translate }}
                  </div>
                </th>
              }
            </tr>
          </thead>
          <tbody>
            @for (sample of samplesChunk; track sample.id) {
              <tr>
                @if (options.labelEnabled) {
                  <td class="font-medium" [style.--col-width]="pageDimensions.columnLabelWidth + 'px'">
                    <div>
                      <b>{{ sample.label }}</b>
                    </div>
                  </td>
                } @else {
                  <td
                    class="col-tiny ion-text-center font-medium"
                    [style.padding]="0"
                    [style.--col-width]="pageDimensions.columnRankOrderWidth + 'px'"
                  >
                    <div>
                      <b>{{ sample.rankOrder }}</b>
                    </div>
                  </td>
                }
                @if (firstPart) {
                  @if (options.taxonNameEnabled) {
                    <td [style.--col-width]="pageDimensions.columnTaxonNameWidth + 'px'">
                      {{ sample.taxonName | referentialToString }}
                    </td>
                  }
                  @if (options.taxonGroupEnabled) {
                    <td [style.--col-width]="pageDimensions.columnTaxonGroupWidth + 'px'">
                      {{ sample.taxonGroup | referentialToString }}
                    </td>
                  }
                }
                @for (pmfm of pmfms.slice(tablePart[0], tablePart[1]); track pmfm.id) {
                  @if (compactPmfmsColumn) {
                    <td class="col-tiny font-small ion-text-center column-{{ pmfm.label }}">
                      @if (pmfm | isNotNil) {
                        <div
                          [innerHTML]="
                            sample.measurementValues
                              | mapGet: pmfm.id
                              | pmfmValue: { pmfm: pmfm, html: false, showYesOrNo: true, propertyNames: ['label'] }
                          "
                        ></div>
                      }
                    </td>
                  } @else {
                    @if (isBlankForm) {
                      <td class="ion-text-center column-{{ pmfm.label }} " [style.--col-width]="pageDimensions.columnPmfmWidth + 'px'">
                        @switch (pmfm | getPmfmExtendedType) {
                          @case ('boolean') {
                            <ion-grid class="value-grid ion-no-padding">
                              <ion-row>
                                <ion-col>
                                  {{ 'COMMON.YES' | translate }}&nbsp;
                                  <ion-icon name="square-outline"></ion-icon>
                                </ion-col>
                                <ion-col>
                                  {{ 'COMMON.NO' | translate }}&nbsp;
                                  <ion-icon name="square-outline"></ion-icon>
                                </ion-col>
                              </ion-row>
                            </ion-grid>
                          }
                          @case ('qualitative_value') {
                            <ion-grid class="value-grid ion-no-padding">
                              <ion-row>
                                @for (qv of pmfm.qualitativeValues; track qv.id) {
                                  <ion-col>
                                    {{ qv.label }}&nbsp;
                                    <ion-icon name="square-outline"></ion-icon>
                                  </ion-col>
                                }
                              </ion-row>
                            </ion-grid>
                          }
                        }
                      </td>
                    } @else {
                      <td
                        class="ion-text-center column-{{ pmfm.label }} "
                        [style.--col-width]="pageDimensions.columnPmfmWidth + 'px'"
                        [innerHtml]="
                          sample.measurementValues
                            | mapGet: pmfm.id
                            | pmfmValue
                              : {
                                  pmfm: pmfmsByIds | mapGet: pmfm.id,
                                  propertyNames: ['label', 'name'],
                                  showYesOrNo: true,
                                }
                        "
                      ></td>
                    }
                  }
                }
                @if (lastPart) {
                  <td class="col-maximum">
                    {{ sample.comments }}
                  </td>
                }
              </tr>
            }
          </tbody>
        </table>
        @if (compactPmfmsColumn || isBlankForm) {
          <table-tips-report-chunk [tips]="pmfmsTips[partIndex] | mapValues | arraySort: sortByTipsIndex"></table-tips-report-chunk>
        }
        <page-footer-from-report-chunk [footerText]="footerText" [help]="footerHelp"></page-footer-from-report-chunk>
      </section>
    }
  }
  <!-- @for ( -->
  <!--   imagesChunk of stats.imagesByOperationId | mapGet: operation.id | splitArrayInChunks: 6; -->
  <!--   track imagesChunkIndex; -->
  <!--   let imagesChunkIndex = $index -->
  <!-- ) { -->
  <!--   <section class="landscape"> -->
  <!--     <page-header-from-report-chunk -->
  <!--       [i18nContext]="i18nContext" -->
  <!--       [title]="'TRIP.SAMPLE.TABLE.TITLE'" -->
  <!--       [pageNumber]="imagesChunkIndex + 1" -->
  <!--       [departureDateTime]="departureDateTime" -->
  <!--       [vesselName]="vesselName" -->
  <!--       [logoRightUrl]="logoHeadRightUrl" -->
  <!--       [logoLeftUrl]="logoHeadLeftUrl" -->
  <!--     ></page-header-from-report-chunk> -->
  <!--     <ion-grid class="report-section ion-no-padding"> -->
  <!--       <ion-row class="section-title ion-margin-bottom"> -->
  <!--         <ion-col size="auto"> -->
  <!--           <h3>{{ 'TRIP.REPORT.FORM.NUM_OP' | translate }}</h3> -->
  <!--         </ion-col> -->
  <!--         <ion-col class="title-value ion-text-center font-large" size="auto"> -->
  <!--           {{ operation.rankOrder }} -->
  <!--         </ion-col> -->
  <!--       </ion-row> -->
  <!--       <ion-row class="gallery"> -->
  <!--         @for (image of imagesChunk; track $index) { -->
  <!--           <ion-col size="auto"> -->
  <!--             <figure> -->
  <!--               <img [src]="image.url || image.dataUrl" [alt]="image.title" /> -->
  <!--               <figcaption>{{ image.title }}</figcaption> -->
  <!--             </figure> -->
  <!--           </ion-col> -->
  <!--         } -->
  <!--       </ion-row> -->
  <!--     </ion-grid> -->
  <!--     <page-footer-from-report-chunk [footerText]="footerText" [help]="footerHelp"></page-footer-from-report-chunk> -->
  <!--   </section> -->
  <!-- } -->
</ng-template>

<ng-template #latudePlaceHolder>
  <span class="font-large place-holder">
    <span [style.letter-spacing]="'3px'">__°__.___</span>
    N
  </span>
</ng-template>

<ng-template #longitudePlaceHolder>
  <span class="font-large place-holder">
    <span [style.letter-spacing]="'3px'">__°__.___</span>
    E ou W
  </span>
</ng-template>
