@if (loaded) {
  <app-reveal #reveal [options]="revealOptions">
    @for (opId of stats.denormalizedBatchByOp | mapKeys; track opId) {
      @if (stats.denormalizedBatchByOp | mapGet: opId; as batchesByType) {
        <section *sectionDef>
          @if (batchesByType | mapGet: 'landing'; as batches) {
            @for (batchesChunk of batches | splitArrayInChunks: 24; track $index; let isLastBatchesChunk = $last , isFirstBatchesChunk = $first) {
              <section class="portrait">
                <page-header-from-report-chunk
                  [i18nContext]="i18nContext"
                  [title]="'TRIP.REPORT.FORM.BATCH.TITLE_LANDING'"
                  [pageNumber]="$index + 1"
                  [departureDateTime]="departureDateTime"
                  [vesselName]="vesselName"
                  [logoRightUrl]="logoHeadRightUrl"
                  [logoLeftUrl]="logoHeadLeftUrl"
                ></page-header-from-report-chunk>
                <ion-grid class="report-section ion-no-padding">
                  <ion-row class="section-title ion-margin-bottom">
                    <ion-col size="auto">
                      <h3>{{ 'TRIP.REPORT.FORM.NUM_OP' | translate }}</h3>
                    </ion-col>
                    <ion-col class="title-value ion-text-center font-large" size="auto">
                      @if (!isBlankForm) {
                        {{ stats.operationRankOrderByOperationIds | mapGet: opId }}
                      }
                    </ion-col>
                  </ion-row>
                </ion-grid>
                <ng-component *ngTemplateOutlet="batchesTable; context: { batches: batchesChunk, opId: opId }"></ng-component>
                <page-footer-from-report-chunk [footerText]="footerText" [help]="footerHelp"></page-footer-from-report-chunk>
              </section>
            }
          }
          @if (batchesByType | mapGet: 'discard'; as batches) {
            @for (batchesChunk of batches | splitArrayInChunks: 24; track $index; let isLastBatchesChunk = $last , isFirstBatchesChunk = $first) {
              <section class="portrait">
                <page-header-from-report-chunk
                  [i18nContext]="i18nContext"
                  [title]="'TRIP.REPORT.FORM.BATCH.TITLE_DISCARD'"
                  [pageNumber]="$index + 1"
                  [departureDateTime]="departureDateTime"
                  [vesselName]="vesselName"
                  [logoRightUrl]="logoHeadRightUrl"
                  [logoLeftUrl]="logoHeadLeftUrl"
                ></page-header-from-report-chunk>
                <ion-grid class="report-section ion-no-padding">
                  <ion-row class="section-title ion-margin-bottom">
                    <ion-col size="auto">
                      <h3>{{ 'TRIP.REPORT.FORM.NUM_OP' | translate }}</h3>
                    </ion-col>
                    <ion-col class="title-value ion-text-center font-large" size="auto">
                      {{ stats.operationRankOrderByOperationIds | mapGet: opId }}
                    </ion-col>
                  </ion-row>
                  @if (isFirstBatchesChunk) {
                    <ion-row class="form-field">
                      <ion-col class="form-label" size="6">
                        {{ 'TRIP.REPORT.FORM.BATCH.PNR_TOTAL_WEIGHT' | translate }}
                      </ion-col>
                      <ion-col class="form-value no-border-bottom" size="2" [class.computed]="batches[0].elevateWeight | isNil">
                        {{ batches[0].elevateWeight || batches[0].indirectWeight }}
                      </ion-col>
                    </ion-row>
                    <ion-row class="form-field">
                      <ion-col class="form-label" size="6">
                        {{ 'TRIP.REPORT.FORM.BATCH.PNR_SAMPLING_WEIGHT' | translate }}
                      </ion-col>
                      <ion-col class="form-value no-border-bottom" size="2" [class.computed]="batches[0].elevateContextWeight | isNil">
                        {{ batches[0].elevateContextWeight || batches[0].indirectContextWeight }}
                      </ion-col>
                    </ion-row>
                    <ion-row class="form-field">
                      <ion-col class="form-label" size="6">
                        {{ 'TRIP.REPORT.FORM.BATCH.FRACTION_FIELD' | translate }}
                      </ion-col>
                      <ion-col class="form-value no-border-bottom" size="2"></ion-col>
                    </ion-row>
                  }
                </ion-grid>
                <ng-component
                  *ngTemplateOutlet="batchesTable; context: { batches: batchesChunk, opId: opId, isLastBatchesChunk: isLastBatchesChunk }"
                ></ng-component>
                <page-footer-from-report-chunk [footerText]="footerText" [help]="footerHelp"></page-footer-from-report-chunk>
              </section>
            }
          }
        </section>
      }
    }
  </app-reveal>
}

<!-- "type" can be 'landing' or 'discard' -->
<ng-template #batchesTable let-batches="batches" let-opId="opId" let-isLastBatchesChunk="isLastBatchesChunk">
  <table [style.--row-height]="'30px'">
    <thead>
      <tr class="group-head">
        <th colspan="4" class="no-border">
          <ion-grid class="ion-no-padding ion-no-margin">
            <ion-row>
              <ion-col size="6" class="vertical-centred-content">
                {{ 'TRIP.REPORT.FORM.BATCH.EXCLUSIVE_SCIENTIFIC_SPECIES' | translate }}
              </ion-col>
              <ion-col size="3" class="vertical-centred-content">
                <ion-icon [style.font-size]="'1.5em'" [name]="batches[0].exhaustiveInventory ? 'checkbox-outline' : 'square-outline'"></ion-icon>
                &nbsp;
                {{ 'COMMON.YES' | translate }}
              </ion-col>
              <ion-col size="3" class="vertical-centred-content">
                <ion-icon [style.font-size]="'1.5em'" [name]="!batches[0].exhaustiveInventory ? 'checkbox-outline' : 'square-outline'"></ion-icon>
                &nbsp;
                {{ 'COMMON.NO' | translate }}
              </ion-col>
            </ion-row>
          </ion-grid>
        </th>
        <th colspan="2" class="col-small"></th>
        <th colspan="3" class="col-small ion-text-center">
          {{ 'TRIP.REPORT.FORM.BATCH.SUB_SAMPLING' | translate }}
        </th>
      </tr>
      <tr>
        <th class="col-tiny no-border ion-text-center no-margin no-padding">
          <mat-icon class="mat-icon mat-icon-sm">arrow_downward</mat-icon>
        </th>
        <th class="col-medium ion-text-center">{{ 'TRIP.REPORT.FORM.BATCH.TAXON_GROUPS' | translate }}</th>
        <th class="col-medium ion-text-center">{{ 'TRIP.REPORT.FORM.BATCH.TAXON_NAMES' | translate }}</th>
        <th class="col-extra-large ion-text-center">{{ 'TRIP.REPORT.FORM.BATCH.SORT_CRITERIAS' | translate }}</th>
        <th class="col-small ion-text-center">{{ 'TRIP.REPORT.FORM.BATCH.TOTAL_WEIGHT' | translate }}</th>
        <th class="col-small ion-text-center">{{ 'TRIP.REPORT.FORM.BATCH.TOTAL_INDIV' | translate }}</th>
        <th class="col-small ion-text-center">{{ 'TRIP.REPORT.FORM.BATCH.FRACTION' | translate }}</th>
        <th class="col-small ion-text-center">{{ 'TRIP.REPORT.FORM.BATCH.WEIGHT' | translate }}</th>
        <th class="col-small ion-text-center">{{ 'TRIP.REPORT.FORM.BATCH.NB_INDIV' | translate }}</th>
      </tr>
    </thead>
    <tbody>
      @for (batch of batches; track batch.id) {
        <tr>
          <td class="col-tiny no-margin no-padding ion-text-center font-large">
            <ion-icon [style.font-size]="'1.1em'" [name]="batch.exhaustiveInventory ? 'checkbox-outline' : 'square-outline'"></ion-icon>
          </td>
          <td class="col-medium">{{ batch.taxonGroup | referentialToString }}</td>
          <td class="col-medium">{{ batch.taxonName | referentialToString }}</td>
          <td class="col-extra-large no-margin no-padding">
            <div class="denormalized-batch-sorting-values">
              <div class="denormalized-batch-tree-indent" [innerHtml]="batch.treeIndent"></div>
              <div class="denormalized-batch-sorting-values-text">
                @if (batch.qualityFlagId | qualityFlagInvalid) {
                  <ion-icon [name]="batch.qualityFlagId | qualityFlagToIcon" color="danger"></ion-icon>
                }
                <b>
                  @if (batch.individualCount === 1) {
                    {{ batch.sortingValuesText }}
                  } @else {
                    @for (pmfmId of batch.measurementValues | mapKeys; track pmfmId; let last = $last) {
                      {{
                        batch.measurementValues
                          | mapGet: pmfmId
                          | pmfmValue
                            : {
                                pmfm: stats.pmfmsByIds | mapGet: pmfmId,
                                propertyNames: ['label', 'name'],
                              }
                      }}
                      @if (!last) {
                        ,&nbsp;
                      }
                    }
                  }
                </b>
              </div>
            </div>
          </td>
          <td class="col-small ion-text-right">
            @if (!(batch | denormalizeBatchIsIndividual)) {
              {{ batch.elevateWeight | number: '1.2-2' }}
            }
          </td>
          <td class="col-small ion-text-right">
            @if (!(batch | denormalizeBatchIsIndividual)) {
              {{ batch.elevateIndividualCount }}
            }
          </td>
          <td class="col-small ion-text-right">{{ batch.samplingRatioText || (batch.samplingRatio | number: '1.2-2') }}</td>
          <td class="col-small ion-text-right" [class.computed]="batch.weight | isNil">
            {{ batch.weight || batch.indirectWeight | number: '1.2-2' }}
          </td>
          <td class="col-small ion-text-right" [class.computed]="batch.individualCount | isNil">
            {{ batch.individualCount || batch.indirectIndividualCount }}
          </td>
        </tr>
      }
    </tbody>
    <tfoot>
      @if (isLastBatchesChunk) {
        <tr>
          <td colspan="4" class="ion-text-end">
            <b>{{ 'TRIP.REPORT.FORM.BATCH.PNR_TOTAL_WEIGHT' | translate }}</b>
          </td>
          <td class="col-small total"></td>
          <td colspan="4" class="col-small"></td>
        </tr>
      }
    </tfoot>
    <caption [innerHTML]="'TRIP.REPORT.FORM.BATCH.TABLE_LEGEND' | translate"></caption>
  </table>
</ng-template>
