<ng-container *ngIf="showToolbar">
  <app-toolbar *ngIf="!modal; else modalToolbar" [defaultBackHref]="$defaultBackHref | async" canGoBack="false">
    <ion-title [innerHTML]="$title | async"></ion-title>

    <ion-buttons slot="end">
      <!-- Refresh -->
      <ion-button *ngIf="uuid | isNilOrBlank" (click)="onRefresh.emit()" [title]="'COMMON.BTN_REFRESH' | translate">
        <mat-icon>refresh</mat-icon>
      </ion-button>

      <!-- Help button -->
      <ion-button (click)="reveal.toggleHelp()">
        <mat-icon>help_outline</mat-icon>
      </ion-button>

      <!-- Print -->
      <!-- FIXME enable for mobile, using a Capacitor plugin ? -->
      <ion-button (click)="print()" *ngIf="!mobile">
        <!-- Print button -->
        <ion-icon name="print"></ion-icon>
      </ion-button>

      <!-- share menu -->
      <button mat-icon-button matHeader [title]="'COMMON.SHARE.BTN_SHARE' | translate" [matMenuTriggerFor]="shareMenu">
        <mat-icon>share</mat-icon>
      </button>
    </ion-buttons>
  </app-toolbar>

  <mat-menu #shareMenu="matMenu" xPosition="after">
    <!-- Share popover -->
    <button mat-menu-item (click)="showSharePopover($event)" [disabled]="(loadingSubject | async) || network.offline">
      <ion-label>{{ 'COMMON.SHARE.BTN_SHARE_DOTS' | translate }}</ion-label>
    </button>
  </mat-menu>

  <ng-template #modalToolbar>
    <app-modal-toolbar *ngIf="showToolbar" [modalName]="modalName" [color]="'secondary'" (cancel)="cancel()" [canValidate]="false">
      <ion-title [innerHTML]="$title | async"></ion-title>

      <!-- Print button -->
      <ion-button slot="end" (click)="reveal.print()">
        <ion-icon name="print"></ion-icon>
      </ion-button>

      <!-- Close button (on desktop screen) -->
      <ion-button hidden-xs hidden-sm hidden-mobile slot="end" (click)="cancel()" (keyup.enter)="cancel()">
        <ion-label translate>COMMON.BTN_CLOSE</ion-label>
      </ion-button>
    </app-modal-toolbar>
  </ng-template>
</ng-container>

<ion-content>
  <ion-item *ngIf="error && showError" lines="none">
    <ion-icon color="danger" slot="start" name="alert-circle"></ion-icon>
    <ion-label color="danger" class="error" [innerHTML]="error | translate"></ion-label>
  </ion-item>

  @if (loaded) {
    <app-reveal #reveal [options]="revealOptions">
      <!-- Trip card -->
      <section *sectionDef class="portrait">
        <!-- Header section -->
        <ion-grid class="report-header ion-no-padding">
          <ion-row class="document-title">
            <ion-col class="logo" size="2">
              @if (stats?.logoHeadLeftUrl | isNotNilOrBlank) {
                <img [src]="stats.logoHeadLeftUrl" />
              }
            </ion-col>
            <ion-col size="8">
              <h1 class="ion-text-uppercase">{{ 'TRIP.REPORT.FORM.TITLE' | translateContext: i18nContext.suffix }}</h1>
              <h2>
                @if (stats?.subtitle | isNotNilOrBlank) {
                  {{ stats.subtitle }}
                } @else {
                  {{ stats.program.description }}
                }
              </h2>
            </ion-col>
            <ion-col class="logo" size="2">
              @if (stats?.logoHeadLeftUrl | isNotNilOrBlank) {
                <img [src]="stats.logoHeadRightUrl" />
              }
            </ion-col>
          </ion-row>
        </ion-grid>

        <!-- Title section -->
        <ion-grid class="report-section">
          <ion-row class="page-title ion-padding">
            <ion-col>
              <h2>{{ 'TRIP.REPORT.FORM.TRIP.TITLE' | translate }}</h2>
            </ion-col>
          </ion-row>
        </ion-grid>

        <!-- Link with the sampling plan section -->
        @if (stats.options.trip.strataEnabled || (data.samplingStrata | isNotNil)) {
          <ion-grid class="report-section">
            <ion-row class="section-title">
              <ion-col>
                <h3>{{ 'TRIP.REPORT.FORM.TRIP.LINK_WITH_THE_SAMPLING_PLAN' | translate }}</h3>
              </ion-col>
            </ion-row>
            <ion-row class="form-field" [style.--form-field-height]="'90px'">
              <ion-col class="form-label" size="4">
                {{ 'TRIP.REPORT.FORM.TRIP.SAMPLING_STATA_LABEL' | translate }}
              </ion-col>
              <ion-col class="form-value" size="8">
                {{ data.samplingStrata?.label }}
              </ion-col>
            </ion-row>
            <ion-row class="form-field">
              <ion-col class="form-label" size="4">
                {{ 'TRIP.REPORT.FORM.TRIP.ATTACHMENT_PROGRAM' | translate }}
              </ion-col>
              <ion-col class="form-value no-border-top" size="8">
                {{ data.samplingStrata?.properties?.samplingSchemeLabel }}
              </ion-col>
            </ion-row>
          </ion-grid>
        }

        <!-- Observers section -->
        @if (stats.options.trip.showObservers) {
          <ion-grid class="report-section">
            <ion-row class="section-title">
              <ion-col>
                <h3>{{ 'TRIP.REPORT.FORM.TRIP.OBSERVERS' | translate }}</h3>
              </ion-col>
            </ion-row>
            <ion-row class="form-field">
              <ion-col class="form-label" size="4">
                {{ 'TRIP.REPORT.FORM.TRIP.OBSERVERS_NAMES' | translate }}
              </ion-col>
              <ion-col class="form-value" size="8">
                {{ data.observers | personToString: ', ' : { withDepartment: true } }}
              </ion-col>
            </ion-row>
          </ion-grid>
        }

        <!-- Trip departure section -->
        <ion-grid class="report-section">
          <ion-row class="section-title">
            <ion-col>
              <h3>{{ 'TRIP.REPORT.FORM.TRIP.TRIP_DEPARTURE' | translate }}</h3>
            </ion-col>
          </ion-row>
          <ion-row class="form-field">
            <ion-col class="form-label" size="4">
              {{ 'TRIP.REPORT.FORM.TRIP.VESSEL_REGISTRATION_CODE' | translate }}
            </ion-col>
            <ion-col class="form-value" size="8">
              {{ data.vesselSnapshot?.registrationCode || data.vesselSnapshot?.intRegistrationCode }}
            </ion-col>
          </ion-row>
          <ion-row class="form-field">
            <ion-col class="form-label" size="4">
              {{ 'TRIP.REPORT.FORM.TRIP.VESSEL_NAME' | translate }}
            </ion-col>
            <ion-col class="form-value no-border-top" size="8">
              {{ data.vesselSnapshot?.name }}
            </ion-col>
          </ion-row>
          <ion-row class="form-field">
            <ion-col class="form-label" size="4">
              {{ 'TRIP.REPORT.FORM.TRIP.DEPARTURE_LOCATION' | translate }}
            </ion-col>
            <ion-col class="form-value no-border-top" size="8">
              <!-- TODO : Location type -->
              {{ data.departureLocation?.name }}
            </ion-col>
          </ion-row>
          <ion-row class="form-field">
            <ion-col class="form-label" size="4">
              {{ 'TRIP.REPORT.FORM.TRIP.DEPARTURE_DATE_TIME' | translate }}
            </ion-col>
            <ion-col class="form-value no-border-top" size="3">
              {{ data.departureDateTime | dateFormat: { time: true } }}
            </ion-col>
            @if (stats.hasPmfm.trip.nbFishermen) {
              <ion-col class="form-label" size="4">
                {{ 'TRIP.REPORT.FORM.TRIP.NB_FISHERMEN' | translateContext: i18nContext.suffix }}
                <br />
                <span class="help">{{ 'TRIP.REPORT.FORM.TRIP.NB_FISHERMEN_HELP' | translate }}</span>
              </ion-col>
              <ion-col class="form-value no-border-top ion-text-right" size="1">
                {{
                  stats.measurementValues.trip
                    | mapGet: stats.pmfmIdsMap.NB_FISHERMEN
                    | pmfmValue: { pmfm: stats.pmfmsByIds.trip | mapGet: stats.pmfmIdsMap.NB_FISHERMEN }
                }}
              </ion-col>
            }
          </ion-row>
        </ion-grid>

        <!-- Trip return section -->
        <ion-grid class="report-section">
          <ion-row class="section-title">
            <ion-col>
              <h3>{{ 'TRIP.REPORT.FORM.TRIP.TRIP_RETURN' | translate }}</h3>
            </ion-col>
          </ion-row>
          <ion-row class="form-field">
            <ion-col class="form-label" size="4">
              {{ 'TRIP.REPORT.FORM.TRIP.RETURN_LOCATION' | translate }}
            </ion-col>
            <ion-col class="form-value" size="8">
              {{ data.returnLocation?.name }}
            </ion-col>
          </ion-row>
          <ion-row class="form-field">
            <ion-col class="form-label" size="4">
              {{ 'TRIP.REPORT.FORM.TRIP.RETURN_DATE_TIME' | translate }}
            </ion-col>
            <ion-col class="form-value no-border-top" size="3">
              {{ data.returnDateTime | dateFormat: { time: true } }}
            </ion-col>
          </ion-row>
        </ion-grid>

        <!-- Sales section -->
        @if (stats.options.trip.showSale) {
          <ion-grid class="report-section">
            <ion-row class="section-title">
              <ion-col>
                <h3>{{ 'TRIP.REPORT.FORM.TRIP.SALES' | translate }}</h3>
              </ion-col>
            </ion-row>
            <ion-row class="form-field">
              <ion-col class="form-label" size="4">
                {{ 'TRIP.REPORT.FORM.TRIP.SELL_LOCATION' | translate }}
              </ion-col>
              <ion-col class="form-value" size="8">
                {{ data.sale?.saleLocation?.name }}
              </ion-col>
            </ion-row>
            <ion-row class="form-field">
              <ion-col class="form-label" size="4">
                {{ 'TRIP.REPORT.FORM.TRIP.SELL_DATE' | translate }}
              </ion-col>
              <ion-col class="form-value no-border-top no-border-bottom" size="3">
                {{ data.sale?.startDateTime | dateFormat: { time: true } }}
              </ion-col>
            </ion-row>
            <ion-row class="form-field">
              <ion-col class="form-label" size="2">
                {{ 'TRIP.REPORT.FORM.TRIP.SELL_TYPE' | translate }}
              </ion-col>
              <ion-col class="form-value horiz-checkbox" size="10">
                <ion-grid>
                  <ion-row>
                    @for (type of stats.saleTypes; track $index) {
                      <ion-col>
                        {{ type }}&nbsp;
                        <ion-icon [name]="data?.sale?.saleType.label === type ? 'checkbox-outline' : 'square-outline'"></ion-icon>
                      </ion-col>
                    }
                  </ion-row>
                </ion-grid>
              </ion-col>
            </ion-row>

            <ion-row class="form-field ion-margin-top">
              <ion-col class="form-label horiz-checkbox" size="6">
                <span>
                  {{ 'TRIP.REPORT.FORM.TRIP.RECOVERY_OF_THE_PHOTOCOPY_OF_THE_LOGBOOK' | translate }}
                  <br />
                  <span class="help">
                    {{ 'TRIP.REPORT.FORM.TRIP.RECOVERY_OF_THE_PHOTOCOPY_OF_THE_LOGBOOK_HELP' | translate }}
                  </span>
                </span>
                <ion-icon [name]="'square-outline'"></ion-icon>
              </ion-col>
              <ion-col class="form-label horiz-checkbox" size="6">
                <span>
                  {{ 'TRIP.REPORT.FORM.TRIP.RETURN_TO_CAPTAIN' | translate }}
                  <br />
                  <span class="help">
                    {{ 'TRIP.REPORT.FORM.TRIP.RETURN_TO_CAPTAIN_HELP' | translate }}
                  </span>
                </span>
                <ion-icon [name]="'square-outline'"></ion-icon>
              </ion-col>
            </ion-row>
          </ion-grid>
        }

        <!-- Other features section -->
        @if (stats.pmfms.trip | isNotEmptyArray) {
          <ion-grid class="report-section">
            <ion-row class="section-title">
              <ion-col>
                <h3>{{ 'TRIP.REPORT.FORM.TRIP.OTHER_FEATURES' | translate }}</h3>
              </ion-col>
            </ion-row>
            @for (pmfm of stats.pmfms.trip; track pmfm.id) {
              <ion-row class="form-field">
                <ion-col class="form-label" size="6">
                  {{ pmfm | pmfmName: { i18nPrefix: i18nContext.pmfmPrefix, i18nSuffix: i18nContext.suffix } }}
                </ion-col>
                <ion-col class="form-value" size="6" [class.no-border-bottom]="!$last">
                  {{ stats.measurementValues.trip | mapGet: pmfm.id | pmfmValue: { pmfm: pmfm, showYesOrNo: true } }}
                </ion-col>
              </ion-row>
            }
          </ion-grid>
        }

        <!-- Comments -->
        <ion-grid class="report-section">
          <ion-row class="section-title">
            <ion-col>
              <h3>{{ 'TRIP.REPORT.FORM.COMMENTS' | translate }}</h3>
            </ion-col>
          </ion-row>
          <ion-row class="form-field" [style.--form-field-height]="'120px'">
            <ion-col class="form-value" size="12">
              {{ data?.comments }}
            </ion-col>
          </ion-row>
        </ion-grid>

        <page-footer-from-report-chunk [footerText]="stats.footerText" [help]="'TRIP.REPORT.FORM.TRIP.HELP'"></page-footer-from-report-chunk>
      </section>

      <!-- Operations table -->
      @if (data.operations | isNotEmptyArray) {
        <section *sectionDef="true">
          @for (ops of data.operations | splitArrayInChunks: operationNbTableSplitArrayChunk; track $index) {
            <section class="landscape">
              <page-header-from-report-chunk
                [i18nContext]="i18nContext"
                [title]="'TRIP.REPORT.FORM.OPERATION.TITLE'"
                [pageNumber]="$index + 1"
                [departureDateTime]="data.departureDateTime"
                [vesselName]="data.vesselSnapshot?.name"
                [logoRightUrl]="stats.logoHeadRightUrl"
                [logoLeftUrl]="stats.logoHeadLeftUrl"
              ></page-header-from-report-chunk>
              <ion-grid class="report-section ion-no-padding">
                <ion-row class="section-title ion-no-margin">
                  <ion-col size="auto">
                    <h3>{{ 'TRIP.REPORT.FORM.OPERATION.NB_OP' | translate }}</h3>
                  </ion-col>
                  <ion-col class="title-value ion-text-center font-large no-border-bottom" size="auto">
                    @if (!isBlankForm) {
                      {{ data.operations?.length }}
                    }
                  </ion-col>
                </ion-row>
              </ion-grid>
              <table>
                <thead>
                  <tr [class.group-head]="!stats.options.operation.allowParentOperation">
                    <th [attr.colspan]="stats.operationTableHeadColspan"></th>
                    <th colspan="2" class="font-medium ion-text-center">
                      <div>{{ 'TRIP.REPORT.FORM.OPERATION.TABLE.OPERATION_START' | translateContext: this.i18nContext.suffix }}</div>
                    </th>
                    <th colspan="2" class="font-medium ion-text-center">
                      <div>{{ 'TRIP.REPORT.FORM.OPERATION.TABLE.OPERATION_END' | translateContext: this.i18nContext.suffix }}</div>
                    </th>
                    @if (stats.options.operation.allowParentOperation) {
                      <th class="col-tiny font-small text-vertical">
                        <div>{{ 'TRIP.REPORT.FORM.TYPE_OP.CHILD_PMFM' | translate }}&nbsp;&#x2B07;</div>
                      </th>
                      @for (pmfm of stats.pmfms.operation | arrayFilter: filterPmfmForOperationTable; track pmfm) {
                        <ng-content *ngTemplateOutlet="tableOperationHeadPmfmName; context: { pmfm: pmfm }"></ng-content>
                      }
                    }
                  </tr>
                  <tr>
                    <th class="col-tiny font-medium text-vertical">
                      <div>{{ 'TRIP.REPORT.FORM.NUM_OP' | translate }}</div>
                    </th>
                    @if (stats.hasPmfm.operation.hasIndividualMeasure) {
                      <th class="col-tiny font-small text-vertical">
                        <div class="text-vertical">
                          {{
                            stats.pmfmsByIds.operation[stats.pmfmIdsMap.HAS_INDIVIDUAL_MEASURES]
                              | pmfmName: { i18nPrefix: i18nContext.pmfmPrefix, i18nSuffix: i18nContext.suffix }
                          }}
                        </div>
                      </th>
                    }
                    @if (stats.hasPmfm.operation.tripProgress) {
                      <th class="col-tiny font-small text-vertical">
                        <div>
                          {{
                            stats.pmfmsByIds.operation[stats.pmfmIdsMap.TRIP_PROGRESS]
                              | pmfmName: { i18nPrefix: i18nContext.pmfmPrefix, i18nSuffix: i18nContext.suffix }
                          }}
                        </div>
                      </th>
                    }
                    <th class="col-extra-large font-medium ion-text-center">
                      <div>{{ 'TRIP.REPORT.FORM.OPERATION.TABLE.GEAR_SPECIES' | translate }}</div>
                    </th>
                    <!-- TODO : Which pmfms use for this -->
                    <!-- <th class="col-small font-small text-vertical"> -->
                    <!--   <div>{{ 'TRIP.REPORT.FORM.OPERATION.TABLE.CAPTURE' | translate }}</div> -->
                    <!-- </th> -->
                    @if (stats.options.operation.showStartDate) {
                      <th class="col-compact font-medium ion-text-center">
                        <div>{{ 'TRIP.REPORT.FORM.DATE_TIME' | translate }}</div>
                      </th>
                      <th class="col-medium font-medium ion-text-center">
                        <div>{{ 'TRIP.REPORT.FORM.OPERATION.TABLE.LAT_LONG_LOCATION' | translate }}</div>
                      </th>
                    }
                    @if (stats.options.operation.showFishingStartDateTime) {
                      <th class="col-compact font-medium ion-text-center">
                        <div>{{ 'TRIP.REPORT.FORM.DATE_TIME' | translate }}</div>
                      </th>
                      <th class="col-medium font-medium ion-text-center">
                        <div>{{ 'TRIP.REPORT.FORM.OPERATION.TABLE.LAT_LONG_LOCATION' | translate }}</div>
                      </th>
                    }
                    @if (stats.options.operation.showFishingEndDateTime) {
                      <th class="col-compact font-medium ion-text-center">
                        <div>{{ 'TRIP.REPORT.FORM.DATE_TIME' | translate }}</div>
                      </th>
                      <th class="col-medium font-medium ion-text-center">
                        <div>{{ 'TRIP.REPORT.FORM.OPERATION.TABLE.LAT_LONG_LOCATION' | translate }}</div>
                      </th>
                    }
                    @if (stats.options.operation.showEndDate) {
                      <th class="col-compact font-medium ion-text-center">
                        <div>{{ 'TRIP.REPORT.FORM.DATE_TIME' | translate }}</div>
                      </th>
                      <th class="col-medium font-medium ion-text-center">
                        <div>{{ 'TRIP.REPORT.FORM.OPERATION.TABLE.LAT_LONG_LOCATION' | translate }}</div>
                      </th>
                    }
                    @if (stats.options.operation.allowParentOperation) {
                      <th class="col-tiny font-small text-vertical">
                        <div>{{ 'TRIP.REPORT.FORM.TYPE_OP.PARENT_PMFM' | translate }}&nbsp;&#x2B07;</div>
                      </th>
                      @for (pmfm of stats.pmfms.childOperation | arrayFilter: filterPmfmForOperationTable; track pmfm) {
                        <ng-content *ngTemplateOutlet="tableOperationHeadPmfmName; context: { pmfm: pmfm }"></ng-content>
                      }
                    } @else {
                      @for (pmfm of stats.pmfms.operation | arrayFilter: filterPmfmForOperationTable; track pmfm) {
                        <ng-content *ngTemplateOutlet="tableOperationHeadPmfmName; context: { pmfm: pmfm }"></ng-content>
                      }
                    }
                  </tr>
                </thead>
                <tbody>
                  @for (op of ops; track op.id; let index = $index) {
                    <tr>
                      <td class="col-tiny ion-text-center font-medium" [style.padding]="0">
                        <div>
                          <b>{{ op.rankOrder }}</b>
                        </div>
                      </td>
                      @if (stats.hasPmfm.operation.hasIndividualMeasure) {
                        <td class="col-tiny ion-text-center">
                          <div
                            [innerHTML]="
                              stats.measurementValues.operations
                                | mapGet: index
                                | mapGet: stats.pmfmIdsMap.HAS_INDIVIDUAL_MEASURES
                                | pmfmValue
                                  : { pmfm: stats.pmfmsByIds.operation | mapGet: stats.pmfmIdsMap.HAS_INDIVIDUAL_MEASURES, showYesOrNo: true }
                            "
                          ></div>
                        </td>
                      }
                      @if (stats.hasPmfm.operation.tripProgress) {
                        <td class="col-tiny ion-text-center">
                          <div
                            [innerHTML]="
                              stats.measurementValues.operations
                                | mapGet: index
                                | mapGet: stats.pmfmIdsMap.TRIP_PROGRESS
                                | pmfmValue: { pmfm: stats.pmfmsByIds.operation | mapGet: stats.pmfmIdsMap.TRIP_PROGRESS, showYesOrNo: true }
                            "
                          ></div>
                        </td>
                      }
                      <!-- metier -->
                      <td class="col-extra-large">
                        @if (!isBlankForm) {
                          <b>[{{ op.physicalGear?.rankOrder }}]</b>
                          {{ op.physicalGear?.gear?.label }}{{ op.metier?.label }} - {{ op.physicalGear?.gear?.name }} {{ op.metier?.name }}
                        }
                      </td>
                      <!-- TODO : See comment on thead -->
                      <!-- <td class="col-tiny ion-text-center"></td> -->
                      <!-- Start date time -->
                      @if (stats.options.operation.showStartDate) {
                        <td class="col-compact">
                          @if (!isBlankForm) {
                            {{ op.startDateTime | dateFormat: { time: true } }}
                          }
                        </td>
                        <!-- Start position -->
                        <td class="col-medium">
                          @if (isBlankForm) {
                            <ng-content *ngTemplateOutlet="latLongPlaceHolder"></ng-content>
                          } @else {
                            {{ op.startPosition?.latitude | latitudeFormat: { pattern: latLongPattern, placeholderChar: '0' } }}
                            <br />
                            {{ op.startPosition?.longitude | longitudeFormat: { pattern: latLongPattern, placeholderChar: '0' } }}
                          }
                        </td>
                      }
                      @if (stats.options.operation.showFishingStartDateTime) {
                        <!-- Fishing start Date time -->
                        <td class="col-compact">
                          @if (!isBlankForm) {
                            {{ op.fishingStartDateTime | dateFormat: { time: true } }}
                          }
                        </td>
                        <!-- Start fishing position -->
                        <td class="col-medium">
                          @if (isBlankForm) {
                            <ng-content *ngTemplateOutlet="latLongPlaceHolder"></ng-content>
                          } @else {
                            {{ op.fishingStartPosition?.latitude | latitudeFormat: { pattern: latLongPattern, placeholderChar: '0' } }}
                            <br />
                            {{ op.fishingStartPosition?.longitude | longitudeFormat: { pattern: latLongPattern, placeholderChar: '0' } }}
                          }
                        </td>
                      }
                      @if (stats.options.operation.showFishingEndDateTime) {
                        <!-- Fishing end date time -->
                        <td class="col-compact">
                          @if (!isBlankForm) {
                            {{ op.fishingEndDateTime | dateFormat: { time: true } }}
                          }
                        </td>
                        <!-- Fishing end position -->
                        <td class="col-medium">
                          @if (isBlankForm) {
                            <ng-content *ngTemplateOutlet="latLongPlaceHolder"></ng-content>
                          } @else {
                            {{ op.fishingEndPosition?.latitude | latitudeFormat: { pattern: latLongPattern, placeholderChar: '0' } }}
                            <br />
                            {{ op.fishingEndPosition?.longitude | longitudeFormat: { pattern: latLongPattern, placeholderChar: '0' } }}
                          }
                        </td>
                      }
                      @if (stats.options.operation.showEndDate) {
                        <!-- End date time -->
                        <td class="col-compact">
                          @if (!isBlankForm) {
                            {{ op.endDateTime | dateFormat: { time: true } }}
                          }
                        </td>
                        <!-- End position -->
                        <td class="col-medium">
                          @if (isBlankForm) {
                            <ng-content *ngTemplateOutlet="latLongPlaceHolder"></ng-content>
                          } @else {
                            {{ op.endPosition?.latitude | latitudeFormat: { pattern: latLongPattern, placeholderChar: '0' } }}
                            <br />
                            {{ op.endPosition?.longitude | longitudeFormat: { pattern: latLongPattern, placeholderChar: '0' } }}
                          }
                        </td>
                      }
                      @if (stats.options.operation.allowParentOperation) {
                        <td class="col-tiny font-small ion-text-center">
                          <div>
                            @if (op.parentOperationId | isNil) {
                              {{ 'TRIP.REPORT.FORM.TYPE_OP.PARENT' | translate }}
                            } @else {
                              {{ 'TRIP.REPORT.FORM.TYPE_OP.CHILD' | translate }}
                            }
                          </div>
                        </td>
                      }
                      @for (
                        pmfm of ((op.parentOperationId | isNotNil) ? stats.pmfms.childOperation : stats.pmfms.operation)
                          | arrayFilter: filterPmfmForOperationTable;
                        track pmfm
                      ) {
                        <td class="col-tiny font-small ion-text-center">
                          @if (pmfm | isNotNil) {
                            <div
                              [innerHTML]="
                                stats.measurementValues.operations
                                  | mapGet: index
                                  | mapGet: pmfm.id
                                  | pmfmValue: { pmfm: pmfm, html: false, showYesOrNo: true, propertyNames: ['label'] }
                              "
                            ></div>
                          }
                        </td>
                      }
                    </tr>
                  }
                </tbody>
              </table>
              <ng-template #tableOperationHeadPmfmName let-pmfm="pmfm">
                <th class="col-tiny font-small text-vertical">
                  @if (pmfm | isNotNil) {
                    <div>
                      {{ pmfm | pmfmName: { i18nPrefix: i18nContext.pmfmPrefix, i18nSuffix: i18nContext.suffix } }}
                      @if (stats.pmfmsTipsByPmfmId.operation | mapGet: pmfm.id | isNotNil) {
                        <sup>
                          <em>*{{ stats.pmfmsTipsByPmfmId.operation | mapGet: pmfm.id | mapGet: 'tipsNum' }}</em>
                        </sup>
                      }
                    </div>
                  }
                </th>
              </ng-template>
              <ul class="caption" [style.margin-top]="'10px'">
                <li>* : {{ 'TRIP.REPORT.FORM.OPERATION.HELP.ONE_STAR' | translate }}</li>
                <li>** : {{ 'TRIP.REPORT.FORM.OPERATION.HELP.TWO_STAR' | translate }}</li>
                @for (key of stats.pmfmsTipsByPmfmId.operation | mapKeys; track $index) {
                  <li>
                    *{{ stats.pmfmsTipsByPmfmId.operation | mapGet: key | mapGet: 'tipsNum' }} :
                    {{ stats.pmfmsTipsByPmfmId.operation | mapGet: key | mapGet: 'text' }}
                  </li>
                }
              </ul>
              <page-footer-from-report-chunk [footerText]="stats.footerText"></page-footer-from-report-chunk>
            </section>

            <!-- Operation comments -->
            <section class="landscape">
              <page-header-from-report-chunk
                [i18nContext]="i18nContext"
                [title]="'TRIP.REPORT.FORM.OPERATION.TITLE_VERSO'"
                [departureDateTime]="data.departureDateTime"
                [vesselName]="data.vesselSnapshot?.name"
                [logoRightUrl]="stats.logoHeadRightUrl"
                [logoLeftUrl]="stats.logoHeadLeftUrl"
              ></page-header-from-report-chunk>
              <table class="table-full-width" [style.margin-top]="'50px'">
                <thead>
                  <tr>
                    <th class="col-tiny font-medium text-vertical">
                      <div>{{ 'TRIP.REPORT.FORM.NUM_OP' | translate }}</div>
                    </th>
                    <th class="col-maximum font-medium">
                      <div>{{ 'TRIP.REPORT.FORM.OPERATION.TABLE.COMMENTS' | translate }}</div>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  @for (op of ops; track $index) {
                    <tr>
                      <td class="col-tiny font-medium ion-text-center" [style.padding]="0">
                        <div>
                          <b>{{ op.rankOrder }}</b>
                        </div>
                      </td>
                      <td class="col-maximum ion-text-left">
                        <div>{{ op.comments }}</div>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
              <page-footer-from-report-chunk [footerText]="stats.footerText"></page-footer-from-report-chunk>
            </section>
          }
        </section>
      }

      <!-- Physical gears -->
      @if (data.gears | isNotEmptyArray) {
        <section *sectionDef>
          @for (physicalGears of data.gears | splitArrayInChunks: 3; track physicalGearSplitIndex; let physicalGearSplitIndex = $index) {
            <section class="portrait">
              <page-header-from-report-chunk
                [i18nContext]="i18nContext"
                [title]="'TRIP.REPORT.FORM.PHYSICAL_GEAR.TITLE'"
                [pageNumber]="physicalGearSplitIndex + 1"
                [departureDateTime]="data.departureDateTime"
                [vesselName]="data.vesselSnapshot?.name"
                [logoRightUrl]="stats.logoHeadRightUrl"
                [logoLeftUrl]="stats.logoHeadLeftUrl"
              ></page-header-from-report-chunk>
              @for (physicalGear of physicalGears; track physicalGear.rankOrder; let physicalGearIndex = $index) {
                <ion-grid class="report-section">
                  <ion-row class="section-title">
                    <ion-col>
                      <h3>{{ physicalGear.gear.label }} - {{ physicalGear.gear.name }}</h3>
                    </ion-col>
                  </ion-row>
                  <ion-row class="form-field ion-margin-bottom">
                    <ion-col class="form-label" size="3">
                      {{ 'TRIP.REPORT.FORM.PHYSICAL_GEAR.OPERATIONS' | translate }}
                    </ion-col>
                    <ion-col class="form-value" size="9">
                      {{ stats.operationsRankByGears[physicalGear.id] | arrayJoin: ', ' }}
                    </ion-col>
                  </ion-row>
                  @for (
                    pmfms of stats.pmfmsByGearsId[physicalGear.gear.id] | splitArrayInChunks: 2;
                    track pmfmSplitIndex;
                    let pmfmSplitIndex = $index
                  ) {
                    <ion-row class="form-field">
                      @for (pmfm of pmfms; track pmfm.id) {
                        <ion-col class="form-label" size="3">
                          {{ pmfm | pmfmName: { i18nPrefix: i18nContext.pmfmPrefix, i18nSuffix: i18nContext.suffix, withUnit: true, html: false } }}
                        </ion-col>
                        <ion-col
                          class="form-value"
                          size="3"
                          [class.no-border-top]="pmfmSplitIndex > 0"
                          [innerHTML]="
                            stats.measurementValues.gears
                              | mapGet: physicalGearIndex * (physicalGearSplitIndex + 1)
                              | mapGet: pmfm.id
                              | pmfmValue: { pmfm: pmfm, html: false, showYesOrNo: true }
                          "
                        ></ion-col>
                      }
                    </ion-row>
                  }
                  <ion-row class="form-field ion-margin-top">
                    <ion-col class="form-label" size="3">
                      {{ 'COMMON.COMMENTS' | translate }}
                    </ion-col>
                    <ion-col class="form-value" size="9">
                      {{ physicalGear.comments }}
                    </ion-col>
                  </ion-row>
                </ion-grid>
              }
              <page-footer-from-report-chunk [footerText]="stats.footerText"></page-footer-from-report-chunk>
            </section>
          }
        </section>
      }

      <!-- DenormalizedBatch by operations -->
      <denormalized-batch-form-report-component
        [tripId]="data.id"
        [data]="data.operations"
        [i18nContext]="i18nContext"
        [isBlankForm]="isBlankForm"
        [program]="stats.program"
        [strategy]="stats.strategy"
        [logoHeadRightUrl]="stats.logoHeadRightUrl"
        [logoHeadLeftUrl]="stats.logoHeadLeftUrl"
        [footerText]="stats.footerText"
        [departureDateTime]="data.departureDateTime"
        [vesselName]="data.vesselSnapshot?.name"
        [revealOptions]="revealOptions"
      ></denormalized-batch-form-report-component>

      <!-- Sample by operation -->
      <sample-form-report-component
        [data]="data.operations"
        [i18nContext]="i18nContext"
        [isBlankForm]="isBlankForm"
        [program]="stats.program"
        [strategy]="stats.strategy"
        [logoHeadRightUrl]="stats.logoHeadRightUrl"
        [logoHeadLeftUrl]="stats.logoHeadLeftUrl"
        [footerText]="stats.footerText"
        [departureDateTime]="data.departureDateTime"
        [vesselName]="data.vesselSnapshot?.name"
        [revealOptions]="revealOptions"
        [samplesByPage]="nbOfSamplePeerOpOnBlankPage"
      ></sample-form-report-component>
    </app-reveal>
  } @else {
    <loader-report-chunk></loader-report-chunk>
  }
</ion-content>

<ng-template #latLongPlaceHolder>
  <span class="font-large place-holder">
    <span [style.letter-spacing]="'3px'">__°__.___</span>
    N
    <br />
    <span [style.letter-spacing]="'3px'">__°__.___</span>
    E ou W
  </span>
</ng-template>
