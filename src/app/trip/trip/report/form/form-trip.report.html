<ng-container *ngIf="showToolbar">
  <app-toolbar *ngIf="!modal; else modalToolbar" [defaultBackHref]="$defaultBackHref | async" canGoBack="false">
    <ion-title [innerHTML]="$title | async"></ion-title>

    <ion-buttons slot="end">
      <!-- Refresh -->
      <ion-button *ngIf="uuid | isNilOrBlank" (click)="onRefresh.emit()" [title]="'COMMON.BTN_REFRESH' | translate">
        <mat-icon>refresh</mat-icon>
      </ion-button>

      <!-- Help button -->
      <ion-button (click)="reveal.toggleHelp()">
        <mat-icon>help_outline</mat-icon>
      </ion-button>

      <!-- Print -->
      <!-- FIXME enable for mobile, using a Capacitor plugin ? -->
      <ion-button (click)="print()" *ngIf="!mobile">
        <!-- Print button -->
        <ion-icon name="print"></ion-icon>
      </ion-button>

      <!-- share menu -->
      <button mat-icon-button matHeader [title]="'COMMON.SHARE.BTN_SHARE' | translate" [matMenuTriggerFor]="shareMenu">
        <mat-icon>share</mat-icon>
      </button>
    </ion-buttons>
  </app-toolbar>

  <mat-menu #shareMenu="matMenu" xPosition="after">
    <!-- Share popover -->
    <button mat-menu-item (click)="showSharePopover($event)" [disabled]="(loadingSubject | async) || network.offline">
      <ion-label>{{ 'COMMON.SHARE.BTN_SHARE_DOTS' | translate }}</ion-label>
    </button>
  </mat-menu>

  <ng-template #modalToolbar>
    <app-modal-toolbar *ngIf="showToolbar" [modalName]="modalName" [color]="'secondary'" (cancel)="cancel()" [canValidate]="false">
      <ion-title [innerHTML]="$title | async"></ion-title>

      <!-- Print button -->
      <ion-button slot="end" (click)="reveal.print()">
        <ion-icon name="print"></ion-icon>
      </ion-button>

      <!-- Close button (on desktop screen) -->
      <ion-button hidden-xs hidden-sm hidden-mobile slot="end" (click)="cancel()" (keyup.enter)="cancel()">
        <ion-label translate>COMMON.BTN_CLOSE</ion-label>
      </ion-button>
    </app-modal-toolbar>
  </ng-template>
</ng-container>

<ion-content>
  <ion-item *ngIf="error && showError" lines="none">
    <ion-icon color="danger" slot="start" name="alert-circle"></ion-icon>
    <ion-label color="danger" class="error" [innerHTML]="error | translate"></ion-label>
  </ion-item>

  @if (loaded) {
    <app-reveal #reveal [options]="revealOptions">
      <!-- Trip card -->
      <section *sectionDef class="portrait" [style.--page-horizontal-margin]="this.pageDimensions.pageHorizontalMargin + 'px'">
        <!-- Header section -->
        <ion-grid class="report-header ion-no-padding">
          <ion-row class="document-title">
            <ion-col class="logo" size="2">
              @if (stats?.logoHeadLeftUrl | isNotNilOrBlank) {
                <img [src]="stats.logoHeadLeftUrl" />
              }
            </ion-col>
            <ion-col size="8">
              <h1 class="ion-text-uppercase">{{ 'TRIP.REPORT.FORM.TITLE' | translateContext: i18nContext.suffix }}</h1>
              <h2>
                @if (stats?.subtitle | isNotNilOrBlank) {
                  {{ stats.subtitle }}
                } @else {
                  {{ stats.program.description }}
                }
              </h2>
            </ion-col>
            <ion-col class="logo" size="2">
              @if (stats?.logoHeadLeftUrl | isNotNilOrBlank) {
                <img [src]="stats.logoHeadRightUrl" />
              }
            </ion-col>
          </ion-row>
        </ion-grid>

        <!-- Title section -->
        <ion-grid class="report-section">
          <ion-row class="page-title ion-padding">
            <ion-col>
              <h2>{{ 'TRIP.REPORT.FORM.TRIP.TITLE' | translate }}</h2>
            </ion-col>
          </ion-row>
        </ion-grid>

        <!-- Link with the sampling plan section -->
        @if (stats.options.strataEnabled || (data.samplingStrata | isNotNil)) {
          <ion-grid class="report-section">
            <ion-row class="section-title">
              <ion-col>
                <h3>{{ 'TRIP.REPORT.FORM.TRIP.LINK_WITH_THE_SAMPLING_PLAN' | translate }}</h3>
              </ion-col>
            </ion-row>
            <ion-row class="form-field" [style.--form-field-height]="'90px'">
              <ion-col class="form-label" size="4">
                {{ 'TRIP.REPORT.FORM.TRIP.SAMPLING_STATA_LABEL' | translate }}
              </ion-col>
              <ion-col class="form-value" size="8">
                {{ data.samplingStrata?.label }}
              </ion-col>
            </ion-row>
            <ion-row class="form-field">
              <ion-col class="form-label" size="4">
                {{ 'TRIP.REPORT.FORM.TRIP.ATTACHMENT_PROGRAM' | translate }}
              </ion-col>
              <ion-col class="form-value no-border-top" size="8">
                {{ data.samplingStrata?.properties?.samplingSchemeLabel }}
              </ion-col>
            </ion-row>
          </ion-grid>
        }

        <!-- Observers section -->
        @if (stats.options.showObservers) {
          <ion-grid class="report-section">
            <ion-row class="section-title">
              <ion-col>
                <h3>{{ 'TRIP.REPORT.FORM.TRIP.OBSERVERS' | translate }}</h3>
              </ion-col>
            </ion-row>
            <ion-row class="form-field">
              <ion-col class="form-label" size="4">
                {{ 'TRIP.REPORT.FORM.TRIP.OBSERVERS_NAMES' | translate }}
              </ion-col>
              <ion-col class="form-value" size="8">
                {{ data.observers | personToString: ', ' : { withDepartment: true } }}
              </ion-col>
            </ion-row>
          </ion-grid>
        }

        <!-- Trip departure section -->
        <ion-grid class="report-section">
          <ion-row class="section-title">
            <ion-col>
              <h3>{{ 'TRIP.REPORT.FORM.TRIP.TRIP_DEPARTURE' | translate }}</h3>
            </ion-col>
          </ion-row>
          <ion-row class="form-field">
            <ion-col class="form-label" size="4">
              {{ 'TRIP.REPORT.FORM.TRIP.VESSEL_REGISTRATION_CODE' | translate }}
            </ion-col>
            <ion-col class="form-value" size="8">
              {{ data.vesselSnapshot?.registrationCode || data.vesselSnapshot?.intRegistrationCode }}
            </ion-col>
          </ion-row>
          <ion-row class="form-field">
            <ion-col class="form-label" size="4">
              {{ 'TRIP.REPORT.FORM.TRIP.VESSEL_NAME' | translate }}
            </ion-col>
            <ion-col class="form-value no-border-top" size="8">
              {{ data.vesselSnapshot?.name }}
            </ion-col>
          </ion-row>
          <ion-row class="form-field">
            <ion-col class="form-label" size="4">
              {{ 'TRIP.REPORT.FORM.TRIP.DEPARTURE_LOCATION' | translate }}
            </ion-col>
            <ion-col class="form-value no-border-top" size="8">
              {{ data.departureLocation | referentialToString: stats.options.displayAttributeLocation }}
            </ion-col>
          </ion-row>
          <ion-row class="form-field">
            <ion-col class="form-label" size="4">
              {{ 'TRIP.REPORT.FORM.TRIP.DEPARTURE_DATE_TIME' | translate }}
            </ion-col>
            <ion-col class="form-value no-border-top" size="3">
              {{ data.departureDateTime | dateFormat: { time: true } }}
            </ion-col>
            @if (stats.hasPmfm.trip.nbFishermen) {
              <ion-col class="form-label" size="4">
                {{ 'TRIP.REPORT.FORM.TRIP.NB_FISHERMEN' | translateContext: i18nContext.suffix }}
                <br />
                <span class="help">{{ 'TRIP.REPORT.FORM.TRIP.NB_FISHERMEN_HELP' | translate }}</span>
              </ion-col>
              <ion-col class="form-value no-border-top ion-text-right" size="1">
                {{
                  stats.measurementValues.trip
                    | mapGet: stats.pmfmIdsMap.NB_FISHERMEN
                    | pmfmValue: { pmfm: stats.pmfmsByIds.trip | mapGet: stats.pmfmIdsMap.NB_FISHERMEN }
                }}
              </ion-col>
            }
          </ion-row>
        </ion-grid>

        <!-- Trip return section -->
        <ion-grid class="report-section">
          <ion-row class="section-title">
            <ion-col>
              <h3>{{ 'TRIP.REPORT.FORM.TRIP.TRIP_RETURN' | translate }}</h3>
            </ion-col>
          </ion-row>
          <ion-row class="form-field">
            <ion-col class="form-label" size="4">
              {{ 'TRIP.REPORT.FORM.TRIP.RETURN_LOCATION' | translate }}
            </ion-col>
            <ion-col class="form-value" size="8">
              {{ data.returnLocation | referentialToString: stats.options.displayAttributeLocation }}
            </ion-col>
          </ion-row>
          <ion-row class="form-field">
            <ion-col class="form-label" size="4">
              {{ 'TRIP.REPORT.FORM.TRIP.RETURN_DATE_TIME' | translate }}
            </ion-col>
            <ion-col class="form-value no-border-top" size="3">
              {{ data.returnDateTime | dateFormat: { time: true } }}
            </ion-col>
          </ion-row>
        </ion-grid>

        <!-- Sales section -->
        @if (stats.options.showSale) {
          <ion-grid class="report-section">
            <ion-row class="section-title">
              <ion-col>
                <h3>{{ 'TRIP.REPORT.FORM.TRIP.SALES' | translate }}</h3>
              </ion-col>
            </ion-row>
            <ion-row class="form-field">
              <ion-col class="form-label" size="4">
                {{ 'TRIP.REPORT.FORM.TRIP.SELL_LOCATION' | translate }}
              </ion-col>
              <ion-col class="form-value" size="8">
                {{ data.sale?.saleLocation | referentialToString: stats.options.displayAttributeLocation }}
              </ion-col>
            </ion-row>
            <ion-row class="form-field">
              <ion-col class="form-label" size="4">
                {{ 'TRIP.REPORT.FORM.TRIP.SELL_DATE' | translate }}
              </ion-col>
              <ion-col class="form-value no-border-top no-border-bottom" size="3">
                {{ data.sale?.startDateTime | dateFormat: { time: true } }}
              </ion-col>
            </ion-row>
            <ion-row class="form-field">
              <ion-col class="form-label" size="2">
                {{ 'TRIP.REPORT.FORM.TRIP.SELL_TYPE' | translate }}
              </ion-col>
              <ion-col class="form-value horiz-checkbox" size="10">
                <ion-grid>
                  <ion-row>
                    @for (type of stats.saleTypes; track $index) {
                      <ion-col>
                        {{ type }}&nbsp;
                        <ion-icon [name]="data?.sale?.saleType.label === type ? 'checkbox-outline' : 'square-outline'"></ion-icon>
                      </ion-col>
                    }
                  </ion-row>
                </ion-grid>
              </ion-col>
            </ion-row>

            <ion-row class="form-field ion-margin-top">
              <ion-col class="form-label horiz-checkbox" size="6">
                <span>
                  {{ 'TRIP.REPORT.FORM.TRIP.RECOVERY_OF_THE_PHOTOCOPY_OF_THE_LOGBOOK' | translate }}
                  <br />
                  <span class="help">
                    {{ 'TRIP.REPORT.FORM.TRIP.RECOVERY_OF_THE_PHOTOCOPY_OF_THE_LOGBOOK_HELP' | translate }}
                  </span>
                </span>
                <ion-icon [name]="'square-outline'"></ion-icon>
              </ion-col>
              <ion-col class="form-label horiz-checkbox" size="6">
                <span>
                  {{ 'TRIP.REPORT.FORM.TRIP.RETURN_TO_CAPTAIN' | translate }}
                  <br />
                  <span class="help">
                    {{ 'TRIP.REPORT.FORM.TRIP.RETURN_TO_CAPTAIN_HELP' | translate }}
                  </span>
                </span>
                <ion-icon [name]="'square-outline'"></ion-icon>
              </ion-col>
            </ion-row>
          </ion-grid>
        }

        <!-- Other features section -->
        @if (stats.pmfms.trip | isNotEmptyArray) {
          <ion-grid class="report-section">
            <ion-row class="section-title">
              <ion-col>
                <h3>{{ 'TRIP.REPORT.FORM.TRIP.OTHER_FEATURES' | translate }}</h3>
              </ion-col>
            </ion-row>
            @for (pmfm of stats.pmfms.trip; track pmfm.id) {
              <ion-row class="form-field">
                <ion-col class="form-label" size="6">
                  {{ pmfm | pmfmName: { i18nPrefix: i18nContext.pmfmPrefix, i18nSuffix: i18nContext.suffix } }}
                </ion-col>
                <ion-col class="form-value" [class.horiz-checkbox]="isBlankForm" size="6" [class.no-border-bottom]="!$last">
                  @if (isBlankForm) {
                    <ion-grid>
                      <ion-row>
                        <ion-col>
                          {{ 'COMMON.YES' | translate }}&nbsp;
                          <ion-icon name="square-outline"></ion-icon>
                        </ion-col>
                        <ion-col>
                          {{ 'COMMON.NO' | translate }}&nbsp;
                          <ion-icon name="square-outline"></ion-icon>
                        </ion-col>
                      </ion-row>
                    </ion-grid>
                  } @else {
                    {{ stats.measurementValues.trip | mapGet: pmfm.id | pmfmValue: { pmfm: pmfm, showYesOrNo: true } }}
                  }
                </ion-col>
              </ion-row>
            }
          </ion-grid>
        }

        <!-- Comments -->
        <ion-grid class="report-section">
          <ion-row class="section-title">
            <ion-col>
              <h3>{{ 'TRIP.REPORT.FORM.COMMENTS' | translate }}</h3>
            </ion-col>
          </ion-row>
          <ion-row class="form-field" [style.--form-field-height]="'120px'">
            <ion-col class="form-value" size="12">
              {{ data?.comments }}
            </ion-col>
          </ion-row>
        </ion-grid>

        <page-footer-from-report-chunk
          [footerText]="stats.footerText"
          [helpText]="'TRIP.REPORT.FORM.TRIP.HELP' | translate: { program: stats.program.label | lowercase | capitalize }"
        ></page-footer-from-report-chunk>
      </section>

      <!-- Operations table -->
      <operation-form-report-component
        [data]="data.operations"
        [i18nContext]="i18nContext"
        [isBlankForm]="isBlankForm"
        [program]="stats.program"
        [strategy]="stats.strategy"
        [logoHeadRightUrl]="stats.logoHeadRightUrl"
        [logoHeadLeftUrl]="stats.logoHeadLeftUrl"
        [footerText]="stats.footerText"
        [departureDateTime]="data.departureDateTime"
        [vesselName]="data.vesselSnapshot?.name"
        [revealOptions]="revealOptions"
        [parentPageDimension]="this.pageDimensions"
        [enablePosition]="stats.options.enablePosition"
      ></operation-form-report-component>

      <!-- Physical gears -->
      @if (data.gears | isNotEmptyArray) {
        <section *sectionDef [style.--page-horizontal-margin]="this.pageDimensions.pageHorizontalMargin + 'px'">
          @for (physicalGears of data.gears | splitArrayInChunks: 3; track physicalGearSplitIndex; let physicalGearSplitIndex = $index) {
            <section class="portrait">
              <page-header-from-report-chunk
                [i18nContext]="i18nContext"
                [title]="'TRIP.REPORT.FORM.PHYSICAL_GEAR.TITLE'"
                [pageNumber]="physicalGearSplitIndex + 1"
                [departureDateTime]="data.departureDateTime"
                [vesselName]="data.vesselSnapshot?.name"
                [logoRightUrl]="stats.logoHeadRightUrl"
                [logoLeftUrl]="stats.logoHeadLeftUrl"
              ></page-header-from-report-chunk>
              @for (physicalGear of physicalGears; track physicalGear.rankOrder; let physicalGearIndex = $index) {
                <ion-grid class="report-section">
                  <ion-row class="section-title">
                    <ion-col>
                      <h3>{{ physicalGear.gear.label }} - {{ physicalGear.gear.name }}</h3>
                    </ion-col>
                  </ion-row>
                  <ion-row class="form-field ion-margin-bottom">
                    <ion-col class="form-label" size="3">
                      {{ 'TRIP.REPORT.FORM.PHYSICAL_GEAR.OPERATIONS' | translate }}
                    </ion-col>
                    <ion-col class="form-value" size="9">
                      {{ stats.operationsRankByGears[physicalGear.id] | arrayJoin: ', ' }}
                    </ion-col>
                  </ion-row>
                  @for (
                    pmfms of stats.pmfmsByGearsId[physicalGear.gear.id] | splitArrayInChunks: 2;
                    track pmfmSplitIndex;
                    let pmfmSplitIndex = $index
                  ) {
                    <ion-row class="form-field">
                      @for (pmfm of pmfms; track pmfm.id) {
                        <ion-col class="form-label" size="3">
                          {{ pmfm | pmfmName: { i18nPrefix: i18nContext.pmfmPrefix, i18nSuffix: i18nContext.suffix, withUnit: true, html: false } }}
                        </ion-col>
                        <ion-col
                          class="form-value"
                          size="3"
                          [class.no-border-top]="pmfmSplitIndex > 0"
                          [innerHTML]="
                            stats.measurementValues.gears
                              | mapGet: physicalGearIndex * (physicalGearSplitIndex + 1)
                              | mapGet: pmfm.id
                              | pmfmValue: { pmfm: pmfm, html: false, showYesOrNo: true }
                          "
                        ></ion-col>
                      }
                    </ion-row>
                  }
                  <ion-row class="form-field ion-margin-top">
                    <ion-col class="form-label" size="3">
                      {{ 'COMMON.COMMENTS' | translate }}
                    </ion-col>
                    <ion-col class="form-value" size="9">
                      {{ physicalGear.comments }}
                    </ion-col>
                  </ion-row>
                </ion-grid>
              }
              <page-footer-from-report-chunk [footerText]="stats.footerText"></page-footer-from-report-chunk>
            </section>
          }
        </section>
      }

      <!-- DenormalizedBatch by operations -->
      <denormalized-batch-form-report-component
        [tripId]="data.id"
        [data]="data.operations"
        [i18nContext]="i18nContext"
        [isBlankForm]="isBlankForm"
        [program]="stats.program"
        [strategy]="stats.strategy"
        [logoHeadRightUrl]="stats.logoHeadRightUrl"
        [logoHeadLeftUrl]="stats.logoHeadLeftUrl"
        [footerText]="stats.footerText"
        [departureDateTime]="data.departureDateTime"
        [vesselName]="data.vesselSnapshot?.name"
        [revealOptions]="revealOptions"
      ></denormalized-batch-form-report-component>

      <!-- Sample by operation -->
      <sample-form-report-component
        [data]="data.operations"
        [i18nContext]="{ prefix: 'TRIP.SAMPLE.PMFM.', suffix: i18nContext.suffix }"
        [isBlankForm]="isBlankForm"
        [program]="stats.program"
        [strategy]="stats.strategy"
        [logoHeadRightUrl]="stats.logoHeadRightUrl"
        [logoHeadLeftUrl]="stats.logoHeadLeftUrl"
        [footerText]="stats.footerText"
        [departureDateTime]="data.departureDateTime"
        [vesselName]="data.vesselSnapshot?.name"
        [revealOptions]="revealOptions"
        [parentPageDimension]="this.pageDimensions"
      ></sample-form-report-component>
    </app-reveal>
  } @else {
    <loader-report-chunk></loader-report-chunk>
  }
</ion-content>
